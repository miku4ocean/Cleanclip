<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CleanClip Test</title>
  <style>
    body { 
      font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; 
    }
    .container { 
      background: white; padding: 20px; border-radius: 8px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .logo { 
      font-size: 24px; font-weight: bold; color: #3b82f6; margin-bottom: 20px; 
    }
    .status { 
      padding: 10px; margin: 10px 0; border-radius: 5px; font-weight: bold;
    }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.loading { background: #cce7ff; color: #004085; }
    textarea { 
      width: 100%; height: 300px; padding: 10px; margin: 10px 0; 
      border: 2px solid #ddd; border-radius: 5px; font-size: 14px;
    }
    button { 
      padding: 10px 20px; margin: 5px; background: #007bff; color: white; 
      border: none; border-radius: 5px; cursor: pointer; font-size: 16px;
    }
    button:hover { background: #0056b3; }
    button:active { background: #004085; }
    .test-info {
      background: #e7f3ff; padding: 15px; border-radius: 5px; margin-bottom: 20px;
      border-left: 4px solid #007bff;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">🧪 CleanClip 測試版</div>
    
    <div class="test-info">
      <strong>測試說明：</strong><br>
      1. 點擊「測試按鈕」檢查 JavaScript 是否工作<br>
      2. 點擊「擷取內容」測試內容擷取功能<br>
      3. 查看狀態訊息了解執行結果
    </div>
    
    <div id="status" class="status loading">準備測試...</div>
    
    <textarea id="textArea" placeholder="擷取的內容會顯示在這裡..."></textarea>
    
    <div>
      <button id="testBtn">🧪 測試按鈕</button>
      <button id="extractBtn">📄 擷取內容</button>
      <button id="saveBtn">💾 儲存文字</button>
    </div>
    
    <div id="debugInfo" style="margin-top: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-family: monospace; font-size: 12px;"></div>
  </div>

  <script>
    console.log('🧪 CleanClip Test Script Loading...');
    
    // Get DOM elements
    const statusEl = document.getElementById('status');
    const textArea = document.getElementById('textArea');
    const testBtn = document.getElementById('testBtn');
    const extractBtn = document.getElementById('extractBtn');
    const saveBtn = document.getElementById('saveBtn');
    const debugInfo = document.getElementById('debugInfo');
    
    function log(message) {
      console.log(message);
      const timestamp = new Date().toLocaleTimeString();
      debugInfo.innerHTML += `<div>[${timestamp}] ${message}</div>`;
      debugInfo.scrollTop = debugInfo.scrollHeight;
    }
    
    function updateStatus(type, message) {
      statusEl.className = `status ${type}`;
      statusEl.textContent = message;
      log(`Status: ${type} - ${message}`);
    }
    
    // Test button function
    function testButton() {
      log('✅ 測試按鈕被點擊！');
      updateStatus('success', 'JavaScript 正常工作！');
      textArea.value = '測試文字 - 如果你看到這個，表示基本功能正常！\n\n時間：' + new Date().toLocaleString();
    }
    
    // Extract content function
    function extractContent() {
      log('🔍 開始內容擷取...');
      updateStatus('loading', '正在擷取內容...');
      
      // Check if we have Chrome extension APIs
      if (typeof chrome === 'undefined' || !chrome.tabs) {
        updateStatus('error', '❌ Chrome 擴充功能 API 不可用');
        log('❌ Chrome APIs not available');
        return;
      }
      
      log('✅ Chrome APIs available');
      
      chrome.tabs.query({active: true, currentWindow: true}, function(tabs) {
        if (chrome.runtime.lastError) {
          const error = chrome.runtime.lastError.message;
          log(`❌ Tab query error: ${error}`);
          updateStatus('error', `權限錯誤: ${error}`);
          return;
        }
        
        if (!tabs || !tabs[0]) {
          log('❌ No active tab found');
          updateStatus('error', '找不到活動分頁');
          return;
        }
        
        const tab = tabs[0];
        log(`✅ Found tab: ${tab.url}`);
        
        if (tab.url.startsWith('chrome://') || tab.url.startsWith('chrome-extension://')) {
          updateStatus('error', '無法在 Chrome 內建頁面擷取內容');
          return;
        }
        
        // Try to inject and execute script
        chrome.scripting.executeScript({
          target: {tabId: tab.id},
          function: () => {
            // This function runs in the context of the web page
            const title = document.title;
            const url = window.location.href;
            
            // Try different content selectors
            const selectors = [
              'article', 'main', '[role="main"]', '.content', 
              '.article-body', '.story-body', '.post-content'
            ];
            
            let content = '';
            let usedSelector = '';
            
            for (const selector of selectors) {
              const element = document.querySelector(selector);
              if (element) {
                const text = element.innerText || element.textContent || '';
                if (text.trim().length > 100) {
                  content = text.trim();
                  usedSelector = selector;
                  break;
                }
              }
            }
            
            if (!content) {
              content = document.body.innerText || document.body.textContent || '';
              usedSelector = 'body';
            }
            
            return {
              title: title,
              url: url,
              content: content.substring(0, 5000), // Limit content size
              length: content.length,
              selector: usedSelector
            };
          }
        }).then((results) => {
          log('✅ Script executed successfully');
          
          if (results && results[0] && results[0].result) {
            const data = results[0].result;
            log(`✅ Content extracted: ${data.length} characters using ${data.selector}`);
            
            textArea.value = `標題：${data.title}\n網址：${data.url}\n使用選擇器：${data.selector}\n內容長度：${data.length} 字符\n\n--- 內容 ---\n${data.content}`;
            updateStatus('success', `✅ 已擷取 ${data.length} 字符的內容`);
          } else {
            log('❌ No result from script execution');
            updateStatus('error', '腳本執行無結果');
          }
        }).catch((error) => {
          log(`❌ Script execution failed: ${error.message}`);
          updateStatus('error', `腳本執行失敗: ${error.message}`);
        });
      });
    }
    
    // Save function
    function saveText() {
      log('💾 儲存按鈕被點擊');
      const text = textArea.value.trim();
      
      if (!text) {
        alert('沒有內容可以儲存');
        return;
      }
      
      try {
        const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `cleanclip-test-${Date.now()}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        log('✅ 檔案已下載');
        updateStatus('success', '✅ 檔案已下載');
      } catch (error) {
        log(`❌ 儲存失敗: ${error.message}`);
        updateStatus('error', `儲存失敗: ${error.message}`);
      }
    }
    
    // Set up event listeners
    log('🔧 設定事件監聽器...');
    
    testBtn.addEventListener('click', testButton);
    extractBtn.addEventListener('click', extractContent);
    saveBtn.addEventListener('click', saveText);
    
    log('✅ 事件監聽器設定完成');
    updateStatus('success', '🧪 測試環境準備完成');
    
    console.log('🧪 CleanClip Test Script Ready');
  </script>
</body>
</html>