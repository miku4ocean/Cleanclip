<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CleanClip Test</title>
  <style>
    body { 
      font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; 
    }
    .container { 
      background: white; padding: 20px; border-radius: 8px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .logo { 
      font-size: 24px; font-weight: bold; color: #3b82f6; margin-bottom: 20px; 
    }
    .status { 
      padding: 10px; margin: 10px 0; border-radius: 5px; font-weight: bold;
    }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.loading { background: #cce7ff; color: #004085; }
    textarea { 
      width: 100%; height: 300px; padding: 10px; margin: 10px 0; 
      border: 2px solid #ddd; border-radius: 5px; font-size: 14px;
    }
    button { 
      padding: 10px 20px; margin: 5px; background: #007bff; color: white; 
      border: none; border-radius: 5px; cursor: pointer; font-size: 16px;
    }
    button:hover { background: #0056b3; }
    button:active { background: #004085; }
    .test-info {
      background: #e7f3ff; padding: 15px; border-radius: 5px; margin-bottom: 20px;
      border-left: 4px solid #007bff;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">ğŸ§ª CleanClip æ¸¬è©¦ç‰ˆ</div>
    
    <div class="test-info">
      <strong>æ¸¬è©¦èªªæ˜ï¼š</strong><br>
      1. é»æ“Šã€Œæ¸¬è©¦æŒ‰éˆ•ã€æª¢æŸ¥ JavaScript æ˜¯å¦å·¥ä½œ<br>
      2. é»æ“Šã€Œæ“·å–å…§å®¹ã€æ¸¬è©¦å…§å®¹æ“·å–åŠŸèƒ½<br>
      3. æŸ¥çœ‹ç‹€æ…‹è¨Šæ¯äº†è§£åŸ·è¡Œçµæœ
    </div>
    
    <div id="status" class="status loading">æº–å‚™æ¸¬è©¦...</div>
    
    <textarea id="textArea" placeholder="æ“·å–çš„å…§å®¹æœƒé¡¯ç¤ºåœ¨é€™è£¡..."></textarea>
    
    <div>
      <button id="testBtn">ğŸ§ª æ¸¬è©¦æŒ‰éˆ•</button>
      <button id="extractBtn">ğŸ“„ æ“·å–å…§å®¹</button>
      <button id="saveBtn">ğŸ’¾ å„²å­˜æ–‡å­—</button>
    </div>
    
    <div id="debugInfo" style="margin-top: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-family: monospace; font-size: 12px;"></div>
  </div>

  <script>
    console.log('ğŸ§ª CleanClip Test Script Loading...');
    
    // Get DOM elements
    const statusEl = document.getElementById('status');
    const textArea = document.getElementById('textArea');
    const testBtn = document.getElementById('testBtn');
    const extractBtn = document.getElementById('extractBtn');
    const saveBtn = document.getElementById('saveBtn');
    const debugInfo = document.getElementById('debugInfo');
    
    function log(message) {
      console.log(message);
      const timestamp = new Date().toLocaleTimeString();
      debugInfo.innerHTML += `<div>[${timestamp}] ${message}</div>`;
      debugInfo.scrollTop = debugInfo.scrollHeight;
    }
    
    function updateStatus(type, message) {
      statusEl.className = `status ${type}`;
      statusEl.textContent = message;
      log(`Status: ${type} - ${message}`);
    }
    
    // Test button function
    function testButton() {
      log('âœ… æ¸¬è©¦æŒ‰éˆ•è¢«é»æ“Šï¼');
      updateStatus('success', 'JavaScript æ­£å¸¸å·¥ä½œï¼');
      textArea.value = 'æ¸¬è©¦æ–‡å­— - å¦‚æœä½ çœ‹åˆ°é€™å€‹ï¼Œè¡¨ç¤ºåŸºæœ¬åŠŸèƒ½æ­£å¸¸ï¼\n\næ™‚é–“ï¼š' + new Date().toLocaleString();
    }
    
    // Extract content function
    function extractContent() {
      log('ğŸ” é–‹å§‹å…§å®¹æ“·å–...');
      updateStatus('loading', 'æ­£åœ¨æ“·å–å…§å®¹...');
      
      // Check if we have Chrome extension APIs
      if (typeof chrome === 'undefined' || !chrome.tabs) {
        updateStatus('error', 'âŒ Chrome æ“´å……åŠŸèƒ½ API ä¸å¯ç”¨');
        log('âŒ Chrome APIs not available');
        return;
      }
      
      log('âœ… Chrome APIs available');
      
      chrome.tabs.query({active: true, currentWindow: true}, function(tabs) {
        if (chrome.runtime.lastError) {
          const error = chrome.runtime.lastError.message;
          log(`âŒ Tab query error: ${error}`);
          updateStatus('error', `æ¬Šé™éŒ¯èª¤: ${error}`);
          return;
        }
        
        if (!tabs || !tabs[0]) {
          log('âŒ No active tab found');
          updateStatus('error', 'æ‰¾ä¸åˆ°æ´»å‹•åˆ†é ');
          return;
        }
        
        const tab = tabs[0];
        log(`âœ… Found tab: ${tab.url}`);
        
        if (tab.url.startsWith('chrome://') || tab.url.startsWith('chrome-extension://')) {
          updateStatus('error', 'ç„¡æ³•åœ¨ Chrome å…§å»ºé é¢æ“·å–å…§å®¹');
          return;
        }
        
        // Try to inject and execute script
        chrome.scripting.executeScript({
          target: {tabId: tab.id},
          function: () => {
            // This function runs in the context of the web page
            const title = document.title;
            const url = window.location.href;
            
            // Try different content selectors
            const selectors = [
              'article', 'main', '[role="main"]', '.content', 
              '.article-body', '.story-body', '.post-content'
            ];
            
            let content = '';
            let usedSelector = '';
            
            for (const selector of selectors) {
              const element = document.querySelector(selector);
              if (element) {
                const text = element.innerText || element.textContent || '';
                if (text.trim().length > 100) {
                  content = text.trim();
                  usedSelector = selector;
                  break;
                }
              }
            }
            
            if (!content) {
              content = document.body.innerText || document.body.textContent || '';
              usedSelector = 'body';
            }
            
            return {
              title: title,
              url: url,
              content: content.substring(0, 5000), // Limit content size
              length: content.length,
              selector: usedSelector
            };
          }
        }).then((results) => {
          log('âœ… Script executed successfully');
          
          if (results && results[0] && results[0].result) {
            const data = results[0].result;
            log(`âœ… Content extracted: ${data.length} characters using ${data.selector}`);
            
            textArea.value = `æ¨™é¡Œï¼š${data.title}\nç¶²å€ï¼š${data.url}\nä½¿ç”¨é¸æ“‡å™¨ï¼š${data.selector}\nå…§å®¹é•·åº¦ï¼š${data.length} å­—ç¬¦\n\n--- å…§å®¹ ---\n${data.content}`;
            updateStatus('success', `âœ… å·²æ“·å– ${data.length} å­—ç¬¦çš„å…§å®¹`);
          } else {
            log('âŒ No result from script execution');
            updateStatus('error', 'è…³æœ¬åŸ·è¡Œç„¡çµæœ');
          }
        }).catch((error) => {
          log(`âŒ Script execution failed: ${error.message}`);
          updateStatus('error', `è…³æœ¬åŸ·è¡Œå¤±æ•—: ${error.message}`);
        });
      });
    }
    
    // Save function
    function saveText() {
      log('ğŸ’¾ å„²å­˜æŒ‰éˆ•è¢«é»æ“Š');
      const text = textArea.value.trim();
      
      if (!text) {
        alert('æ²’æœ‰å…§å®¹å¯ä»¥å„²å­˜');
        return;
      }
      
      try {
        const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `cleanclip-test-${Date.now()}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        log('âœ… æª”æ¡ˆå·²ä¸‹è¼‰');
        updateStatus('success', 'âœ… æª”æ¡ˆå·²ä¸‹è¼‰');
      } catch (error) {
        log(`âŒ å„²å­˜å¤±æ•—: ${error.message}`);
        updateStatus('error', `å„²å­˜å¤±æ•—: ${error.message}`);
      }
    }
    
    // Set up event listeners
    log('ğŸ”§ è¨­å®šäº‹ä»¶ç›£è½å™¨...');
    
    testBtn.addEventListener('click', testButton);
    extractBtn.addEventListener('click', extractContent);
    saveBtn.addEventListener('click', saveText);
    
    log('âœ… äº‹ä»¶ç›£è½å™¨è¨­å®šå®Œæˆ');
    updateStatus('success', 'ğŸ§ª æ¸¬è©¦ç’°å¢ƒæº–å‚™å®Œæˆ');
    
    console.log('ğŸ§ª CleanClip Test Script Ready');
  </script>
</body>
</html>