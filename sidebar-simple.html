<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CleanClip Simple</title>
    <style>
        body { 
            margin: 0; padding: 20px; font-family: Arial, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; min-height: 100vh;
        }
        .card { 
            background: rgba(255,255,255,0.95); color: #333; padding: 30px; 
            border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); 
            backdrop-filter: blur(10px);
        }
        h1 { color: #4a5568; margin: 0 0 20px 0; font-size: 28px; }
        .status { 
            padding: 15px; margin: 15px 0; border-radius: 8px; font-weight: bold;
            border-left: 5px solid #3182ce;
        }
        .success { background: #c6f6d5; color: #2f855a; border-color: #38a169; }
        .error { background: #fed7d7; color: #c53030; border-color: #e53e3e; }
        .loading { background: #bee3f8; color: #2b6cb0; border-color: #3182ce; }
        textarea { 
            width: 100%; height: 200px; padding: 15px; border: 2px solid #e2e8f0; 
            border-radius: 8px; font-size: 14px; font-family: monospace;
            resize: vertical; box-sizing: border-box;
        }
        .btn { 
            display: inline-block; padding: 12px 24px; margin: 8px; 
            background: #4299e1; color: white; border: none; border-radius: 6px; 
            cursor: pointer; font-size: 16px; text-decoration: none;
            transition: all 0.2s ease;
        }
        .btn:hover { background: #3182ce; transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn.success { background: #48bb78; }
        .btn.success:hover { background: #38a169; }
        .debug { 
            background: #1a202c; color: #e2e8f0; padding: 15px; border-radius: 8px; 
            margin-top: 20px; max-height: 200px; overflow-y: auto; font-family: monospace;
            font-size: 12px; line-height: 1.4;
        }
        .step { margin: 10px 0; padding: 10px; background: #f7fafc; border-radius: 5px; }
        .emoji { font-size: 20px; margin-right: 8px; }
        .highlight { background: #ffd700; color: #333; padding: 2px 6px; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="card">
        <h1><span class="emoji">ğŸ§¹</span>CleanClip ç°¡åŒ–ç‰ˆ</h1>
        
        <div class="step">
            <div class="emoji">ğŸ“‹</div>
            <strong>ä½¿ç”¨èªªæ˜</strong><br>
            1. é»æ“Šã€Œæ¸¬è©¦ã€ç¢ºèªæŒ‰éˆ•åŠŸèƒ½<br>
            2. é»æ“Šã€Œæ“·å–ã€å–å¾—ç¶²é å…§å®¹<br>
            3. ç·¨è¼¯å…§å®¹å¾Œé»æ“Šã€Œå„²å­˜ã€
        </div>
        
        <div id="status" class="status loading">
            <span class="emoji">â³</span>æº–å‚™ä¸­...
        </div>
        
        <div style="margin: 20px 0;">
            <button class="btn" onclick="testFunction()">
                <span class="emoji">ğŸ§ª</span>æ¸¬è©¦
            </button>
            <button class="btn" onclick="extractContent()">
                <span class="emoji">ğŸ“„</span>æ“·å–
            </button>
            <button class="btn success" onclick="saveText()">
                <span class="emoji">ğŸ’¾</span>å„²å­˜
            </button>
        </div>
        
        <textarea id="content" placeholder="æ“·å–çš„å…§å®¹æœƒé¡¯ç¤ºåœ¨é€™è£¡...&#10;&#10;ä½ ä¹Ÿå¯ä»¥ç›´æ¥åœ¨é€™è£¡è¼¸å…¥æˆ–è²¼ä¸Šæ–‡å­—é€²è¡Œç·¨è¼¯ã€‚"></textarea>
        
        <div id="debug" class="debug">
            <div><strong>ğŸ” é™¤éŒ¯è³‡è¨Šï¼š</strong></div>
            <div>ç­‰å¾…æ“ä½œ...</div>
        </div>
    </div>

    <script>
        // é˜²æ­¢æ‰€æœ‰éŒ¯èª¤
        window.onerror = function(msg, url, line, col, error) {
            console.log('Error caught:', msg);
            return true; // é˜²æ­¢é»˜èªéŒ¯èª¤è™•ç†
        };
        
        let debugEl, statusEl, contentEl;
        
        // ç­‰å¾… DOM åŠ è¼‰å®Œæˆ
        function initializeElements() {
            debugEl = document.getElementById('debug');
            statusEl = document.getElementById('status');  
            contentEl = document.getElementById('content');
            
            if (debugEl && statusEl && contentEl) {
                log('âœ… æ‰€æœ‰å…ƒç´ åˆå§‹åŒ–æˆåŠŸ');
                setStatus('success', 'âœ… æº–å‚™å®Œæˆï¼Œè«‹é»æ“ŠæŒ‰éˆ•æ¸¬è©¦');
                return true;
            }
            return false;
        }
        
        function log(message) {
            console.log(message);
            if (debugEl) {
                const time = new Date().toLocaleTimeString();
                debugEl.innerHTML += `<div>[${time}] ${message}</div>`;
                debugEl.scrollTop = debugEl.scrollHeight;
            }
        }
        
        function setStatus(type, message) {
            if (statusEl) {
                statusEl.className = `status ${type}`;
                statusEl.innerHTML = `<span class="emoji">${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â³'}</span>${message}`;
            }
            log(`ç‹€æ…‹: ${message}`);
        }
        
        // æ¸¬è©¦å‡½æ•¸
        function testFunction() {
            log('ğŸ§ª æ¸¬è©¦æŒ‰éˆ•è¢«é»æ“Šï¼');
            setStatus('success', 'ğŸ‰ æŒ‰éˆ•åŠŸèƒ½æ­£å¸¸ï¼');
            if (contentEl) {
                contentEl.value = `ğŸ§ª æ¸¬è©¦æˆåŠŸï¼\næ™‚é–“ï¼š${new Date().toLocaleString()}\n\nå¦‚æœä½ çœ‹åˆ°é€™å€‹è¨Šæ¯ï¼Œè¡¨ç¤ºåŸºæœ¬åŠŸèƒ½éƒ½æ­£å¸¸é‹ä½œã€‚\n\nç¾åœ¨å¯ä»¥å˜—è©¦é»æ“Šã€Œæ“·å–ã€æŒ‰éˆ•ä¾†å–å¾—ç¶²é å…§å®¹ã€‚`;
            }
        }
        
        // æ“·å–å…§å®¹å‡½æ•¸
        function extractContent() {
            log('ğŸ“„ é–‹å§‹æ“·å–å…§å®¹...');
            setStatus('loading', 'â³ æ­£åœ¨æ“·å–ç¶²é å…§å®¹...');
            
            try {
                // æª¢æŸ¥ Chrome API
                if (typeof chrome === 'undefined') {
                    throw new Error('Chrome API ä¸å¯ç”¨');
                }
                
                log('âœ… Chrome API å¯ç”¨');
                
                chrome.tabs.query({active: true, currentWindow: true}, function(tabs) {
                    if (chrome.runtime.lastError) {
                        log('âŒ åˆ†é æŸ¥è©¢éŒ¯èª¤: ' + chrome.runtime.lastError.message);
                        setStatus('error', 'âŒ æ¬Šé™éŒ¯èª¤');
                        return;
                    }
                    
                    if (!tabs || tabs.length === 0) {
                        log('âŒ æ‰¾ä¸åˆ°æ´»å‹•åˆ†é ');
                        setStatus('error', 'âŒ æ‰¾ä¸åˆ°åˆ†é ');
                        return;
                    }
                    
                    const tab = tabs[0];
                    log(`ğŸ“„ æ‰¾åˆ°åˆ†é : ${tab.url}`);
                    
                    chrome.scripting.executeScript({
                        target: { tabId: tab.id },
                        function: function() {
                            try {
                                const title = document.title || 'æœªçŸ¥æ¨™é¡Œ';
                                let content = '';
                                
                                // å˜—è©¦ä¸åŒçš„é¸æ“‡å™¨
                                const selectors = ['article', 'main', '.content', '.article-body', '.story-body'];
                                
                                for (let selector of selectors) {
                                    const element = document.querySelector(selector);
                                    if (element) {
                                        const text = element.innerText || '';
                                        if (text.trim().length > 100) {
                                            content = text.trim();
                                            break;
                                        }
                                    }
                                }
                                
                                if (!content) {
                                    content = document.body.innerText || document.body.textContent || '';
                                }
                                
                                return {
                                    title: title,
                                    content: content.substring(0, 3000), // é™åˆ¶å…§å®¹é•·åº¦
                                    length: content.length,
                                    url: window.location.href
                                };
                            } catch (e) {
                                return { error: e.message };
                            }
                        }
                    }, function(results) {
                        if (chrome.runtime.lastError) {
                            log('âŒ è…³æœ¬åŸ·è¡ŒéŒ¯èª¤: ' + chrome.runtime.lastError.message);
                            setStatus('error', 'âŒ è…³æœ¬åŸ·è¡Œå¤±æ•—');
                            return;
                        }
                        
                        if (results && results[0] && results[0].result) {
                            const data = results[0].result;
                            
                            if (data.error) {
                                log('âŒ å…§å®¹æ“·å–éŒ¯èª¤: ' + data.error);
                                setStatus('error', 'âŒ å…§å®¹æ“·å–å¤±æ•—');
                                return;
                            }
                            
                            log(`âœ… æˆåŠŸæ“·å– ${data.length} å­—ç¬¦`);
                            setStatus('success', `âœ… å·²æ“·å– ${data.length} å­—ç¬¦`);
                            
                            if (contentEl) {
                                contentEl.value = `æ¨™é¡Œï¼š${data.title}\nç¶²å€ï¼š${data.url}\né•·åº¦ï¼š${data.length} å­—ç¬¦\n\n--- å…§å®¹ ---\n${data.content}`;
                            }
                        } else {
                            log('âŒ ç„¡æ“·å–çµæœ');
                            setStatus('error', 'âŒ ç„¡æ³•å–å¾—å…§å®¹');
                        }
                    });
                });
                
            } catch (error) {
                log('âŒ æ“·å–å¤±æ•—: ' + error.message);
                setStatus('error', 'âŒ åŠŸèƒ½ç•°å¸¸: ' + error.message);
            }
        }
        
        // å„²å­˜å‡½æ•¸
        function saveText() {
            log('ğŸ’¾ å„²å­˜æŒ‰éˆ•è¢«é»æ“Š');
            
            if (!contentEl || !contentEl.value.trim()) {
                alert('æ²’æœ‰å…§å®¹å¯ä»¥å„²å­˜');
                return;
            }
            
            try {
                const text = contentEl.value;
                const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cleanclip-${Date.now()}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                log('âœ… æª”æ¡ˆå·²ä¸‹è¼‰');
                setStatus('success', 'âœ… æª”æ¡ˆä¸‹è¼‰å®Œæˆ');
            } catch (error) {
                log('âŒ å„²å­˜å¤±æ•—: ' + error.message);
                setStatus('error', 'âŒ å„²å­˜å¤±æ•—');
            }
        }
        
        // åˆå§‹åŒ–
        setTimeout(function() {
            if (initializeElements()) {
                log('ğŸš€ CleanClip ç°¡åŒ–ç‰ˆè¼‰å…¥å®Œæˆ');
            } else {
                console.error('Elements not found');
            }
        }, 100);
    </script>
</body>
</html>