<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CleanClip Isolated</title>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        .container { 
            width: 100%; height: 100vh; background: #f0f4f8; 
            display: flex; flex-direction: column;
        }
        .header { 
            background: #4299e1; color: white; padding: 15px; 
            font-size: 18px; font-weight: bold;
        }
        .quick-test { 
            padding: 20px; background: #fff3cd; border-left: 4px solid #ffc107; 
            margin: 10px; border-radius: 5px;
        }
        .test-btn { 
            padding: 10px 20px; background: #28a745; color: white; 
            border: none; border-radius: 5px; cursor: pointer; 
            font-size: 14px; margin: 5px;
        }
        .result { 
            padding: 10px; margin: 10px; background: white; border-radius: 5px; 
            border-left: 4px solid #17a2b8; min-height: 200px;
        }
        textarea { 
            width: calc(100% - 20px); height: 200px; margin: 10px; 
            padding: 10px; border: 1px solid #ddd; border-radius: 5px;
        }
        .actions { padding: 10px; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">ğŸ§ª CleanClip éš”é›¢æ¸¬è©¦ç‰ˆ</div>
        
        <div class="quick-test">
            <strong>âš¡ å¿«é€Ÿæ¸¬è©¦ï¼š</strong> é»æ“Šä¸‹æ–¹æŒ‰éˆ•æ¸¬è©¦åŸºæœ¬åŠŸèƒ½
            <br><br>
            <button class="test-btn" onclick="quickTest()">ğŸ§ª æ¸¬è©¦ JavaScript</button>
            <button class="test-btn" onclick="testChrome()">ğŸ”§ æ¸¬è©¦ Chrome API</button>
            <button class="test-btn" onclick="extractNow()">ğŸ“„ ç«‹å³æ“·å–</button>
        </div>
        
        <div class="result">
            <div id="status">ç­‰å¾…æ¸¬è©¦...</div>
            <textarea id="content" placeholder="æ“·å–çµæœæˆ–æ¸¬è©¦è¼¸å‡ºå°‡é¡¯ç¤ºåœ¨é€™è£¡..."></textarea>
        </div>
        
        <div class="actions">
            <button class="test-btn" onclick="saveContent()" style="background: #dc3545;">ğŸ’¾ å„²å­˜å…§å®¹</button>
            <button class="test-btn" onclick="clearAll()" style="background: #6c757d;">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
    </div>

    <script>
        // ç«‹å³åŸ·è¡Œï¼Œé¿å…ä»»ä½•å»¶é²
        (function() {
            console.log('ğŸš€ CleanClip Isolated Loading...');
            
            // ç²å–å…ƒç´ 
            const statusEl = document.getElementById('status');
            const contentEl = document.getElementById('content');
            
            function log(msg) {
                console.log(msg);
                if (statusEl) {
                    statusEl.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + msg + '</div>';
                }
            }
            
            // æ¸¬è©¦ JavaScript åŸºæœ¬åŠŸèƒ½
            window.quickTest = function() {
                log('âœ… JavaScript å·¥ä½œæ­£å¸¸ï¼');
                if (contentEl) {
                    contentEl.value = 'ğŸ‰ æ¸¬è©¦æˆåŠŸï¼\n\n' +
                        'æ™‚é–“ï¼š' + new Date().toLocaleString() + '\n' +
                        'ç”¨æˆ¶ä»£ç†ï¼š' + navigator.userAgent + '\n' +
                        'é é¢æ¨™é¡Œï¼š' + document.title + '\n\n' +
                        'å¦‚æœä½ çœ‹åˆ°é€™å€‹è¨Šæ¯ï¼Œè¡¨ç¤º JavaScript åŠŸèƒ½å®Œå…¨æ­£å¸¸ï¼';
                }
            };
            
            // æ¸¬è©¦ Chrome API
            window.testChrome = function() {
                log('ğŸ” æª¢æŸ¥ Chrome API...');
                
                if (typeof chrome === 'undefined') {
                    log('âŒ Chrome API ä¸å¯ç”¨');
                    return;
                }
                
                log('âœ… Chrome API å¯ç”¨');
                
                try {
                    chrome.tabs.query({active: true, currentWindow: true}, function(tabs) {
                        if (chrome.runtime.lastError) {
                            log('âŒ API éŒ¯èª¤: ' + chrome.runtime.lastError.message);
                            return;
                        }
                        
                        if (tabs && tabs[0]) {
                            log('âœ… æ‰¾åˆ°æ´»å‹•åˆ†é : ' + tabs[0].url);
                            if (contentEl) {
                                contentEl.value = 'ğŸ”§ Chrome API æ¸¬è©¦çµæœï¼š\n\n' +
                                    'âœ… chrome.tabs.query å·¥ä½œæ­£å¸¸\n' +
                                    'âœ… æ‰¾åˆ°æ´»å‹•åˆ†é \n' +
                                    'ğŸ“„ åˆ†é æ¨™é¡Œ: ' + tabs[0].title + '\n' +
                                    'ğŸ”— åˆ†é ç¶²å€: ' + tabs[0].url + '\n' +
                                    'ğŸ†” åˆ†é  ID: ' + tabs[0].id + '\n\n' +
                                    'æ‰€æœ‰ API åŠŸèƒ½æ­£å¸¸ï¼Œå¯ä»¥é€²è¡Œå…§å®¹æ“·å–ï¼';
                            }
                        } else {
                            log('âŒ æ‰¾ä¸åˆ°æ´»å‹•åˆ†é ');
                        }
                    });
                } catch (error) {
                    log('âŒ API æ¸¬è©¦å¤±æ•—: ' + error.message);
                }
            };
            
            // ç«‹å³æ“·å–å…§å®¹
            window.extractNow = function() {
                log('ğŸ“„ é–‹å§‹å…§å®¹æ“·å–...');
                
                if (typeof chrome === 'undefined' || !chrome.tabs || !chrome.scripting) {
                    log('âŒ Chrome æ“´å……åŠŸèƒ½ API ä¸å¯ç”¨');
                    return;
                }
                
                chrome.tabs.query({active: true, currentWindow: true}, function(tabs) {
                    if (chrome.runtime.lastError || !tabs || !tabs[0]) {
                        log('âŒ ç„¡æ³•ç²å–æ´»å‹•åˆ†é ');
                        return;
                    }
                    
                    const tab = tabs[0];
                    log('ğŸ“„ å°è±¡åˆ†é : ' + tab.url);
                    
                    chrome.scripting.executeScript({
                        target: { tabId: tab.id },
                        function: function() {
                            // åœ¨é é¢ä¸­åŸ·è¡Œçš„å‡½æ•¸
                            const title = document.title;
                            const url = window.location.href;
                            
                            // å˜—è©¦å„ç¨®å…§å®¹é¸æ“‡å™¨
                            const selectors = [
                                'article',
                                'main', 
                                '[role="main"]',
                                '.article-body',
                                '.story-body',
                                '.content',
                                '.post-content',
                                '.entry-content'
                            ];
                            
                            let bestContent = '';
                            let usedSelector = '';
                            
                            for (let selector of selectors) {
                                const elements = document.querySelectorAll(selector);
                                for (let elem of elements) {
                                    const text = elem.innerText || elem.textContent || '';
                                    if (text.trim().length > 200) {
                                        bestContent = text.trim();
                                        usedSelector = selector;
                                        break;
                                    }
                                }
                                if (bestContent) break;
                            }
                            
                            // å¦‚æœæ²’æ‰¾åˆ°ï¼Œä½¿ç”¨ body
                            if (!bestContent) {
                                const bodyText = document.body.innerText || document.body.textContent || '';
                                if (bodyText.trim().length > 100) {
                                    bestContent = bodyText.trim();
                                    usedSelector = 'body (fallback)';
                                }
                            }
                            
                            return {
                                title: title,
                                url: url,
                                content: bestContent.substring(0, 4000), // é™åˆ¶é•·åº¦
                                fullLength: bestContent.length,
                                selector: usedSelector,
                                timestamp: new Date().toLocaleString()
                            };
                        }
                    }, function(results) {
                        if (chrome.runtime.lastError) {
                            log('âŒ è…³æœ¬åŸ·è¡ŒéŒ¯èª¤: ' + chrome.runtime.lastError.message);
                            return;
                        }
                        
                        if (results && results[0] && results[0].result) {
                            const data = results[0].result;
                            log('âœ… å…§å®¹æ“·å–æˆåŠŸ: ' + data.fullLength + ' å­—ç¬¦');
                            
                            if (contentEl) {
                                contentEl.value = 'ğŸ“„ å…§å®¹æ“·å–çµæœ\n' +
                                    'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n' +
                                    'ğŸ·ï¸ æ¨™é¡Œ: ' + data.title + '\n' +
                                    'ğŸ”— ç¶²å€: ' + data.url + '\n' +
                                    'ğŸ“ é•·åº¦: ' + data.fullLength + ' å­—ç¬¦\n' +
                                    'ğŸ¯ é¸æ“‡å™¨: ' + data.selector + '\n' +
                                    'â° æ™‚é–“: ' + data.timestamp + '\n' +
                                    'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n' +
                                    data.content + '\n\n' +
                                    '--- å…§å®¹æ“·å–å®Œæˆ ---';
                            }
                        } else {
                            log('âŒ ç„¡æ³•ç²å–æ“·å–çµæœ');
                        }
                    });
                });
            };
            
            // å„²å­˜å…§å®¹
            window.saveContent = function() {
                if (!contentEl || !contentEl.value.trim()) {
                    alert('æ²’æœ‰å…§å®¹å¯ä»¥å„²å­˜ï¼');
                    return;
                }
                
                try {
                    const text = contentEl.value;
                    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'cleanclip-' + Date.now() + '.txt';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    log('âœ… æª”æ¡ˆå·²ä¸‹è¼‰');
                } catch (error) {
                    log('âŒ å„²å­˜å¤±æ•—: ' + error.message);
                }
            };
            
            // æ¸…ç©ºå…§å®¹
            window.clearAll = function() {
                if (contentEl) contentEl.value = '';
                if (statusEl) statusEl.innerHTML = 'å·²æ¸…ç©ºï¼Œæº–å‚™é‡æ–°æ¸¬è©¦...';
                log('ğŸ—‘ï¸ å…§å®¹å·²æ¸…ç©º');
            };
            
            // åˆå§‹åŒ–å®Œæˆ
            log('ğŸš€ éš”é›¢ç‰ˆæœ¬åˆå§‹åŒ–å®Œæˆ');
            log('ğŸ’¡ è«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹æ¸¬è©¦');
            
        })(); // ç«‹å³åŸ·è¡Œå‡½æ•¸çµæŸ
    </script>
</body>
</html>